rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
   match /users/{userId} {
      allow read: if request.auth.uid != null;
    	allow write: if request.auth.uid == userId ||
      	get(/databases/$(database)/documents/users/$(request.auth.uid)).data.data.role == 'manager';
    }

    match /contracts/{contractId} {
    	function tenantAllowedContract () {
        return resource.data.tenantId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.data.tenantId
      }
      function tenantAllowed(contractId) {
        return get(/databases/$(database)/documents/contracts/$(contractId)).data.tenantId in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.data.tenantId
      }
      function managerAllowed() {
      	return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.data.role == 'manager'
      }

 			allow read, write: if tenantAllowedContract() || managerAllowed();

      match /versions/{versionId} {
      	allow read, write: if tenantAllowed(contractId) || managerAllowed();
      }
      match /sessions/{sessionId} {
      	allow read, write: if tenantAllowed(contractId) || managerAllowed();
      }
      match /comments/{commentId} {
      	allow read, write: if tenantAllowed(contractId) || managerAllowed();
      }
      match /events/{eventId} {
      	allow read, write: if tenantAllowed(contractId) || managerAllowed();
      }
      match /activity/{activityId} {
        allow read: if tenantAllowed(contractId) || managerAllowed();
      }
      match /tasks/{taskId} {
      	allow read, write: if tenantAllowed(contractId) || managerAllowed();
      }
    }

    match /templates/{templateId} {
    	allow read: if request.auth.uid != null;
    	allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.data.role == 'manager';
    }

    match /clauses/{clauseId} {
    	allow read: if request.auth.uid != null;
    	allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.data.role == 'manager';
    }

    match /defaults/{clauseId} {
    	allow read: if request.auth.uid != null;
    	allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.data.role == 'manager';
    }

    match /tenants/{tenantId} {
        allow read, write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.data.tenantId == resource.data.number ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.data.role == 'manager';
    }

    match /sendEmails/{eventId} {
    	  allow read, write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.data.role == 'manager';
    }

    match /SOUserData/{soUid} {
    	allow read: if request.auth.uid != null;
    }

    match /buildings/{bId} {
    	allow read: if request.auth.uid != null;
    }
    
    match /featureFlags/{bId} {
    	allow read: if request.auth.uid != null;
    }
  }
}